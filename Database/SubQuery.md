### SubQuery
---

<br>

>### __서브쿼리__

<br>

- __하나의 SQL문 안에 포함되어 있는 또 다른 SQL문__
- 서브쿼리를 쓰는 이유는 알려지지 않은 기준을 이용한 검색을 하기 위해서 사용
- __메인쿼리의 컬럼을 모두 사용할 수 있지만 메인쿼리는 서브쿼리의 컬럼을 사용하지 못함__
- 서브쿼리를 사용해야할 때 조인을 사용하는 실수할 가능성이 있음
- 하나의 select문 안에 포함되어 있는 select 문장
- 여러 절에서 사용할 수 있으나 select문 안에 포함되어 있는 것이 일반적

<br>

~~~
select 검색할 컬럼들
from 테이블명
where 형식 연산자 (select 검색할 컬럼들
                  from 테이블명
                  ......            )
~~~

<br>

### 서브쿼리의 위치에 따른 명칭

- select 문에 있는 서브쿼리 : 스칼라 서브쿼리

~~~
select cd_plant, nm_plant (select avg(um) from table_item) as um
from table_plant
~~~

<br>

- from 절에 있는 서브쿼리 : 인라인 뷰

__서브쿼리에서 조회된 값을 테이블처럼 활용 가능__
~~~
select cd_plant, nm_plant, am
from (select * from table_plant)
~~~

<br>

- where 절에 있는 서브쿼리 : 서브쿼리

~~~
select cd_plant
from table_plant
where cd_plant in (select cd_plant
                   from table_plant
                   where plant = '1000' and company = '0327')
~~~

<br>

이 밖에도 __Having, Order By, Insert문의 value, Update문의 set, 집계함수__ 등 다양한 곳에서 사용 가능하며 서브쿼리 안에 서브쿼리로 __여러 개의 서브쿼리를 중첩해서 사용가능__

<br>

### 서브쿼리쓸 때 주의사항

- 반드시 괄호()로 감싸서 사용
- 단일행 또는 복수행 비교연산자 사용 가능
(단, 단일행 비교연산자는 서브쿼리의 결과가 반드시 1건 이하)
- __서브쿼리 내에서 Order by 사용 불가__
- 메인쿼리의 마지막 문장에 위치해야 함
- 서브쿼리는 거의 모든 구문에서 사용이 가능 (Group By절 제외)
- 연산자의 오른쪽에 위치해야함

<br>

- 형식 연산자
  - 단일행 연산자 ( =, >, >=, <, <=, <> )
  - 복수행 연산자 ( IN, ANY, ALL, NOT IN)

<br><br>

>### __서브쿼리의 반환 값에 따른 서브쿼리 종류__

<br>

- __단일 행 서브쿼리 (Single-Row Subquery)__
  서브쿼리의 결과가 1행

<br>

- __다중 행 서브쿼리 (Multiple-Row Subquery)__
  서브쿼리의 결과가 여러 행

<br>

- __다중 컬럼 서브쿼리 (Multi-Column Subquery)__
  서브쿼리의 결과가 여러 컬럼

<br>

- __스칼라 서브쿼리 (Scala Subquery)__
  select문에서 사용하는 서브쿼리로 1행만 반환

<br>

- __상호연관 서브쿼리 (Correlated Subquery)__
  메인 쿼리의 값을 서브쿼리가 사용하고 서브쿼리의 값을 받아서 메인쿼리가 계산하는 구조의 쿼리  

<br><br>

>### __단일행 서브쿼리__

<br>

- 메인 쿼리로 전달되는 행이 단 하나인 경우
- 단일행 연산자를 사용

<br><br>

>### __다중행 서브쿼리__

<br>

__서브쿼리의 결과가 2건 이상 반환될 수 있다면 '반드시' 다중행 비교 연산자 (IN, ALL, ANY, SOME)과 함꼐 사용해야 함__

<br>

- 메인 쿼리로 전달되는 행이 여러 개인 경우
- 다중 행 연산자 IN, ANY, ALL을 사용

<br>

~~~
다중 행 연산자

IN  : 서브쿼리의 결과에 존재하는 값과 동일한 조건
      (검색된 값 중에 하나만 일치하면 참)

ALL : 비교 연산자에 ">"를 썼다면 ALL이 모든 값을 만족하는 조건이기 때문에 결과중에
      가장 큰 값보다 커야 만족한다는 뜻
      (모든 검색된 값과 조건에 맞아야 함)

ANY : 비교 연산자에 ">"를 썼다면 ANY가 어떤 하나라도 맞는지 조건이기 때문에
      결과 중에 가장 작은 값보다 크면 만족한다는 뜻
      (검색된 값 중에 조건에 맞는 것이 하나 이상 있으면 참)
      ( = SOME )       
~~~

<br><br>

### ALL과 ANY 정리

<br>

사용|의미|같은 표현
---|---|---
컬럼 > ANY | 가장 작은 값보다 크다 | 컬럼 > MIN
컬럼 < ANY | 가장 큰 값보다 작다 | 컬럼 < MAX
컬럼 > ALL | 가장 큰 값보다 크다 | 컬럼 > MAX
컬럼 < ALL | 가장 작은 값보다 작다 | 컬럼 < MIN
